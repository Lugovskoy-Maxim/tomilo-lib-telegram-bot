name: Deploy Telegram Bot to home server

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Telegram Bot to home server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_SSH_PORT || 22 }}
          script: |
            echo "ðŸš€ Deploying Telegram Bot to server..."

            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
            PROJECT_DIR="/mnt/sdb1/tomilo-lib-telegram-bot"
            mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR"
            echo "Current directory: $(pwd)"

            # ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
            if [ ! -d .git ]; then
              echo "Cloning repository for the first time..."
              git clone https://github.com/${{ github.repository }}.git .
            else
              echo "Updating existing repository..."
              git fetch origin
              git reset --hard origin/main
            fi

            echo "Project contents:"
            ls -la

            # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Node.js Ñ‡ÐµÑ€ÐµÐ· nvm
            echo "ðŸ”§ Setting up Node.js..."
            if [ -s "$HOME/.nvm/nvm.sh" ]; then
              source "$HOME/.nvm/nvm.sh"
            else
              echo "Installing nvm..."
              curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash
              source "$HOME/.nvm/nvm.sh"
            fi

            if ! nvm ls 20 &> /dev/null; then
              echo "Installing Node.js 20..."
              nvm install 20
            fi
            nvm use 20
            nvm alias default 20

            echo "Node.js version: $(node --version)"
            echo "npm version: $(npm --version)"

            # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
            echo "ðŸ“¦ Installing dependencies..."
            npm install

            # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ PM2
            echo "ðŸ”„ Restarting Telegram Bot with PM2..."
            pm2 stop tomilo-lib-bot 2>/dev/null || true
            pm2 delete tomilo-lib-bot 2>/dev/null || true

            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ecosystem Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ PM2
            cat > ecosystem.config.js << 'EOF'
            module.exports = {
              apps: [{
                name: 'tomilo-lib-bot',
                script: 'npm',
                args: 'start',
                instances: 1,
                exec_mode: 'fork',
                env: {
                  NODE_ENV: 'production'
                },
                error_file: './logs/err.log',
                out_file: './logs/out.log',
                log_file: './logs/combined.log',
                time: true
              }]
            }
            EOF

            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð²
            mkdir -p logs

            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°
            pm2 start ecosystem.config.js

            # Ð”Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼Ñ Ð½Ð° Ð·Ð°Ð¿ÑƒÑÐº
            sleep 5

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
            echo "PM2 process list:"
            pm2 ls

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð±Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»ÑÑ
            echo "ðŸ” Checking if bot is running..."
            if pm2 show tomilo-lib-bot | grep -q "online"; then
              echo "âœ… PM2 process is online"
            else
              echo "âŒ PM2 process is not online"
              pm2 logs tomilo-lib-bot --lines 20
              exit 1
            fi

            echo "âœ… Successfully deployed Telegram Bot!"

